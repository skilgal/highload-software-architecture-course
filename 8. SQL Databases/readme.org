#+TITLE: Readme

* Pre Setup
** Create Users table
I'm using [[https://www.mycli.net/][mycli]] as terminal client

1. Install CLI `brew install mycli`
2. Run create table script
#+begin_src bash
mycli db -u user -p password < create-db.sql
#+end_src
** Insert 40B users
I used python client to insert batches of data. 50_000 per 1 transaction

#+begin_src bash
python3 ./gen-data.py
#+end_src

#+begin_src bash
MySQL user@localhost:db> select count(*) from users
+----------+
| count(*) |
+----------+
| 42320111 |
+----------+
1 row in set
Time: 52.257s
#+end_src
* Select requests by birthdate
** Without index
#+begin_src sql
select count(*) from users where `birthDate` = '2021-11-21'
+----------+
| count(*) |
+----------+
| 103466   |
+----------+
1 row in set
#+end_src

** With BTree index
1. Create index
  #+begin_src sql

    CREATE INDEX birthDate_index
    USING BTREE
    ON users ( birthDate )

    Query OK, 0 rows affected
    Time: 109.112s
  #+end_src

2. Run equal search query
   #+begin_src sql
    select count(*) from users where `birthDate` = '2021-11-21'
    +----------+
    | count(*) |
    +----------+
    | 103466   |
    +----------+
    1 row in set
    Time: 0.043s

   #+end_src
3. Run comparison search query
   #+begin_src sql
    select count(*) from users where `birthDate` < '2021-11-21'
    +----------+
    | count(*) |
    +----------+
    | 42216645 |
    +----------+
    1 row in set
    Time: 47.308s
   #+end_src
4. Drop index
   #+begin_src sql
     DROP INDEX birthDate_index ON users;
   #+end_src
** With Hash index
1. Create index
#+begin_src sql
    CREATE INDEX birthDate_index
    USING HASH
    ON users ( birthDate )

    Query OK, 0 rows affected
    Time: 107.162s
#+end_src

1. Run equal search query
   #+begin_src sql
    select count(*) from users where `birthDate` = '2021-11-21'
    +----------+
    | count(*) |
    +----------+
    | 103466   |
    +----------+
    1 row in set
    Time: 0.039s
   #+end_src

2. Run comparison search query
    #+begin_src sql
        select count(*) from users where `birthDate` < '2021-11-21'
        +----------+
        | count(*) |
        +----------+
        | 42216645 |
        +----------+
        1 row in set
        Time: 47.549s
    #+end_src

3. Drop index
   #+begin_src sql
     DROP INDEX birthDate_index ON users;
   #+end_src

* Insertion speed

#+begin_src mysql
SET GLOBAL innodb_flush_log_at_trx_commit=0;
SHOW VARIABLES LIKE 'innodb_flush_log_at_trx_commit';
+--------------------------------+-------+
| Variable_name                  | Value |
+--------------------------------+-------+
| innodb_flush_log_at_trx_commit | 0     |
+--------------------------------+-------+
1 row in set
Time: 0.026s
#+end_src

Count of inserted rows

** Siege during 30 seconds
| innodb_flush_log_at_trx_commit \ concurrent user count |    10 |    25 |    50 |   100 |
|--------------------------------------------------------+-------+-------+-------+-------|
|                                                      0 | 15169 | 11534 | 16328 | 16314 |
|                                                      1 |  8693 | 11136 | 13699 | 15971 |
|                                                      2 | 15756 | 12807 | 14659 | 14344 |


** Siege during 60 seconds

| innodb_flush_log_at_trx_commit \ concurrent user count |    10 |    25 |    50 |   100 |
|--------------------------------------------------------+-------+-------+-------+-------|
|                                                      0 | 32650 | 28823 | 27512 | 26229 |
|                                                      1 | 28482 | 31300 | 25245 | 25015 |
|                                                      2 | 31875 | 29040 | 27035 | 25273 |
